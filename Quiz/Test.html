<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFA Aircraft Rec</title>
    <link rel="stylesheet" href="../cleancss.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../CSS/test.css">
</head>
<body>
    <main>
        <!-- #Replace with DB-inserted aircraft -->
        <div id="cover">
            <img src="../img/Aircraft/" alt="" id="disappearingImg">
        </div>
        <h2>What is the manufacturer?</h2>
        <ul id="manufacturerUl">
            <li><p></p></li>
            <li><p></p></li>
            <li><p></p></li>
            <li><p></p></li>
        </ul>
        <h2>What is the model?</h2>
        <ul id="modelUl">
            <li><p></p></li>
            <li><p></p></li>
            <li><p></p></li>
            <li><p></p></li>
        </ul>
        <h2>What is the common name?</h2>
        <ul id="commonNameUl">
            <li><p></p></li>
            <li><p></p></li>
            <li><p></p></li>
            <li><p></p></li>
        </ul>
        <div class="buttons">
            <button id="submit"><p>Submit</p></button>
            <p id="skip">Next Question</p></div>
        </div>
        <a href="/menu" class="leave">
            <p>Go back</p>
        </a>
    </main>
    <script src="../script.js"></script>
    <script>
    // Function to handle answer selection
    function handleAnswerSelection(event) {
        if (event.target.tagName === 'P') { // Ensure we're clicking on the <p> element
            const answers = event.target.closest('ul').querySelectorAll('p');
            answers.forEach(answer => answer.classList.remove('selected')); // Remove 'selected' from all answers
            event.target.classList.add('selected'); // Add 'selected' to clicked answer
        }
    }

    // Initialize correct streak counter 
    let correctStreak = 0;
    let highScore = parseInt(getCookie('highScore')) || 0; // Initialize high score from cookie or to 0 if not set

    // Function to submit answers
    function handleSubmit() {
        const answers = document.querySelectorAll('ul li p.selected'); // Only consider selected answers
        let allCorrect = true; // Assume all answers are correct initially

        answers.forEach(answer => {
            answer.classList.remove('selected'); // Remove 'selected' class
            if (answer.getAttribute('data-is-correct') === 'true') {
                answer.classList.add('correct'); // Correct answer
            } else {
                answer.classList.add('wrong'); // Incorrect answer
                allCorrect = false; // Found an incorrect answer
            }
        });

        // Optionally, highlight the correct answer if not selected
        document.querySelectorAll('ul li p').forEach(answer => {
            if (answer.getAttribute('data-is-correct') === 'true') {
                answer.classList.add('correct'); // Ensure the correct answer is always highlighted
            }
        });

        // Update correct streak counter
        if (allCorrect && answers.length === 3) { // Check if all answers are correct and there are exactly 3 answers
            correctStreak++;
        } else {
            correctStreak = 0; // Reset streak if any answer is wrong
        }

        // Update high score if current streak is greater
        if (correctStreak > highScore) {
            highScore = correctStreak;
            setHighScoreCookie(highScore);
        }

        // Store the correct streak in a cookie
        setCorrectStreakCookie(correctStreak);
    }

    // Function to set the correct streak cookie
    function setCorrectStreakCookie(streak) {
        const d = new Date();
        d.setTime(d.getTime() + (30*24*60*60*1000)); // Set cookie to expire in 30 days
        let expires = "expires="+ d.toUTCString();
        document.cookie = "correctStreak=" + streak + ";" + expires + ";path=/";
    }

    // Function to set the high score cookie
    function setHighScoreCookie(score) {
        const d = new Date();
        d.setTime(d.getTime() + (365*24*60*60*1000)); // Set cookie to expire in 1 year
        let expires = "expires="+ d.toUTCString();
        document.cookie = "highScore=" + score + ";" + expires + ";path=/";
    }

    // Function to get a cookie by name
    function getCookie(name) {
        let nameEQ = name + "=";
        let ca = document.cookie.split(';');
        for(let i=0;i < ca.length;i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }

        // Function to reset classes for the next question
        function resetAnswerClasses() {
            const answers = document.querySelectorAll('ul li p');
            answers.forEach(answer => {
                answer.classList.remove('selected', 'correct', 'wrong'); // Remove all related classes
            });
        }

        document.querySelector('main').addEventListener('click', function(event) {
            handleAnswerSelection(event);
        });

        // Add event listener to the submit button
        document.getElementById('submit').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default form submission if applicable
            handleSubmit();
        });

        // Modify the existing skip button event listener to also reset classes
        document.getElementById('skip').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default action if applicable
            resetAnswerClasses();
            fetchAndDisplayQuestion(); // Call the original function to fetch and display the next question
        });

        // Function to shuffle an array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
        }

        // Function to fetch and display a new aircraft question
        function fetchAndDisplayQuestion() {
            fetch('http://127.0.0.1:1337/random-question') // Adjust the fetch URL as necessary
                .then(response => response.json())
                .then(questionData => {
                    console.log(questionData); // Debugging: Log the received data

                    // Display the image
                    const aircraftImage = document.getElementById('disappearingImg');
                    aircraftImage.src = `/img/Aircraft/${questionData.correctAircraft.id-1}.png`;

                    // Combine wrong and correct answers, then shuffle for manufacturer
                    let manufacturerAnswers = shuffleArray([...questionData.wrongAnswers, questionData.correctAircraft]);
                    const manufacturerUl = document.getElementById('manufacturerUl');
                    manufacturerUl.innerHTML = manufacturerAnswers.map(answer => `<li><p data-is-correct="${answer.manufacturer === questionData.correctAircraft.manufacturer}">${answer.manufacturer}</p></li>`).join('');

                    // Combine wrong and correct answers, then shuffle for model
                    let modelAnswers = shuffleArray([...questionData.wrongAnswers, questionData.correctAircraft]);
                    const modelUl = document.getElementById('modelUl');
                    modelUl.innerHTML = modelAnswers.map(answer => `<li><p data-is-correct="${answer.model === questionData.correctAircraft.model}">${answer.model}</p></li>`).join('');

                    // Combine wrong and correct answers, then shuffle for common name
                    let commonNameAnswers = shuffleArray([...questionData.wrongAnswers, questionData.correctAircraft]);
                    const commonNameUl = document.getElementById('commonNameUl');
                    commonNameUl.innerHTML = commonNameAnswers.map(answer => `<li><p data-is-correct="${answer.altname === questionData.correctAircraft.altname}">${answer.altname}</p></li>`).join('');

                    // Reset image visibility and timer for the new question
                    resetImageVisibility();
                })
                .catch(error => console.error('Error fetching question data:', error));
        }

        // Function to reset image visibility and timer
        function resetImageVisibility() {
            const cover = document.getElementById('cover');
            cover.classList.remove('hidden'); // Remove 'hidden' class to show the image
    
            // Reset the timer to hide the image after 3 seconds
            setTimeout(() => {
                cover.classList.add('hidden');
            }, 3000);
        }

        // Initial call to load the first question
        fetchAndDisplayQuestion();
    </script>
</body>
</html>